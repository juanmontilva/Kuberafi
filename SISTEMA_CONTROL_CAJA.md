# üí∞ Sistema de Control de Caja para Operadores - Kuberafi

## üìã Descripci√≥n

Sistema completo de **control de fondos de caja** para operadores de casas de cambio. Permite gestionar saldos por m√©todo de pago y moneda, con actualizaci√≥n autom√°tica al procesar √≥rdenes.

---

## ‚ú® Caracter√≠sticas Principales

### 1. **Saldos por M√©todo de Pago y Moneda**
- ‚úÖ Cada operador tiene saldos independientes
- ‚úÖ Separados por m√©todo de pago (Zelle, Pago M√≥vil, etc.)
- ‚úÖ Separados por moneda (USD, VES, EUR, etc.)
- ‚úÖ Balance en tiempo real

### 2. **Movimientos Autom√°ticos**
- ‚úÖ Al completar una orden, se actualizan autom√°ticamente los saldos
- ‚úÖ Entrada de dinero (cliente paga)
- ‚úÖ Salida de dinero (operador entrega)
- ‚úÖ Historial completo de transacciones

### 3. **Movimientos Manuales**
- ‚úÖ Dep√≥sitos (agregar fondos a caja)
- ‚úÖ Retiros (sacar fondos de caja)
- ‚úÖ Ajustes (correcciones)
- ‚úÖ Descripci√≥n y justificaci√≥n

### 4. **Historial y Reportes**
- ‚úÖ Movimientos del d√≠a
- ‚úÖ Historial completo con filtros
- ‚úÖ Balance antes y despu√©s de cada movimiento
- ‚úÖ Vinculaci√≥n con √≥rdenes

---

## üóÑÔ∏è Estructura de Base de Datos

### Tabla: `operator_cash_balances`

```sql
CREATE TABLE operator_cash_balances (
    id BIGINT PRIMARY KEY,
    operator_id BIGINT,           -- Operador due√±o del saldo
    payment_method_id BIGINT,     -- M√©todo de pago (Zelle, PM, etc.)
    currency VARCHAR(10),          -- Moneda (USD, VES, etc.)
    balance DECIMAL(15,2),         -- Saldo actual
    created_at TIMESTAMP,
    updated_at TIMESTAMP,
    UNIQUE(operator_id, payment_method_id, currency)
);
```

### Tabla: `cash_movements`

```sql
CREATE TABLE cash_movements (
    id BIGINT PRIMARY KEY,
    operator_id BIGINT,
    payment_method_id BIGINT,
    order_id BIGINT NULL,          -- Orden relacionada (si aplica)
    type ENUM('deposit', 'withdrawal', 'order_in', 'order_out', 'adjustment'),
    currency VARCHAR(10),
    amount DECIMAL(15,2),          -- Positivo = entrada, Negativo = salida
    balance_before DECIMAL(15,2),  -- Saldo antes del movimiento
    balance_after DECIMAL(15,2),   -- Saldo despu√©s del movimiento
    description TEXT,
    created_at TIMESTAMP,
    updated_at TIMESTAMP
);
```

---

## üéØ Ejemplo de Uso

### Escenario: Orden de USD a VES

**Situaci√≥n Inicial:**
```
Operador: Juan
M√©todo: Zelle
- Saldo USD: $1,000
- Saldo VES: Bs. 50,000
```

**Cliente quiere cambiar:**
- $100 USD ‚Üí VES
- Tasa: 36.50
- Recibe: Bs. 3,650

**Proceso Autom√°tico:**

1. **Entrada de USD** (cliente paga)
   ```
   Tipo: order_in
   Moneda: USD
   Monto: +$100
   Balance antes: $1,000
   Balance despu√©s: $1,100
   ```

2. **Salida de VES** (operador entrega)
   ```
   Tipo: order_out
   Moneda: VES
   Monto: -Bs. 3,650
   Balance antes: Bs. 50,000
   Balance despu√©s: Bs. 46,350
   ```

**Resultado Final:**
```
Operador: Juan
M√©todo: Zelle
- Saldo USD: $1,100 ‚úÖ
- Saldo VES: Bs. 46,350 ‚úÖ
```

---

## üîß Archivos Creados

### Backend (6 archivos)

#### 1. Migraciones
```
database/migrations/2025_10_28_222251_create_operator_cash_balances_table.php
database/migrations/2025_10_28_222302_create_cash_movements_table.php
```

#### 2. Modelos
```php
app/Models/OperatorCashBalance.php
app/Models/CashMovement.php
```

#### 3. Controlador
```php
app/Http/Controllers/CashBoxController.php
```

#### 4. Rutas
```php
routes/web.php
// GET  /cash-box
// POST /cash-box/movement
// GET  /cash-box/history
```

### Frontend (Pendiente)
```
resources/js/pages/CashBox/Index.tsx
resources/js/pages/CashBox/History.tsx
```

---

## üìä Interfaz de Usuario (Propuesta)

### P√°gina Principal: `/cash-box`

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ üí∞ Mi Fondo de Caja                                 ‚îÇ
‚îÇ Control de saldos por m√©todo de pago                ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ                                                     ‚îÇ
‚îÇ üìä Resumen del D√≠a                                  ‚îÇ
‚îÇ ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê                 ‚îÇ
‚îÇ ‚îÇ Entradas ‚îÇ Salidas  ‚îÇ Neto     ‚îÇ                 ‚îÇ
‚îÇ ‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§                 ‚îÇ
‚îÇ ‚îÇ $500     ‚îÇ $300     ‚îÇ +$200    ‚îÇ                 ‚îÇ
‚îÇ ‚îÇ Bs 18K   ‚îÇ Bs 12K   ‚îÇ +Bs 6K   ‚îÇ                 ‚îÇ
‚îÇ ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò                 ‚îÇ
‚îÇ                                                     ‚îÇ
‚îÇ üíµ Saldos por M√©todo de Pago                        ‚îÇ
‚îÇ                                                     ‚îÇ
‚îÇ üè¶ Zelle                                            ‚îÇ
‚îÇ USD: $1,100.00                                      ‚îÇ
‚îÇ [+ Depositar] [- Retirar]                          ‚îÇ
‚îÇ                                                     ‚îÇ
‚îÇ üì± Pago M√≥vil                                       ‚îÇ
‚îÇ VES: Bs. 46,350.00                                  ‚îÇ
‚îÇ [+ Depositar] [- Retirar]                          ‚îÇ
‚îÇ                                                     ‚îÇ
‚îÇ üìú Movimientos Recientes                            ‚îÇ
‚îÇ ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê            ‚îÇ
‚îÇ ‚îÇ ‚úÖ Orden #1234 - Entrada USD        ‚îÇ            ‚îÇ
‚îÇ ‚îÇ +$100.00 | Balance: $1,100.00       ‚îÇ            ‚îÇ
‚îÇ ‚îÇ Hace 5 minutos                      ‚îÇ            ‚îÇ
‚îÇ ‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§            ‚îÇ
‚îÇ ‚îÇ ‚ùå Orden #1234 - Salida VES         ‚îÇ            ‚îÇ
‚îÇ ‚îÇ -Bs. 3,650.00 | Balance: Bs 46,350  ‚îÇ            ‚îÇ
‚îÇ ‚îÇ Hace 5 minutos                      ‚îÇ            ‚îÇ
‚îÇ ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò            ‚îÇ
‚îÇ                                                     ‚îÇ
‚îÇ [Ver Historial Completo]                           ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

### Modal: Registrar Dep√≥sito/Retiro

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ üí∞ Registrar Movimiento             ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ                                     ‚îÇ
‚îÇ Tipo:                               ‚îÇ
‚îÇ ‚óã Dep√≥sito  ‚óè Retiro  ‚óã Ajuste     ‚îÇ
‚îÇ                                     ‚îÇ
‚îÇ M√©todo de Pago:                     ‚îÇ
‚îÇ [Zelle ‚ñº]                           ‚îÇ
‚îÇ                                     ‚îÇ
‚îÇ Moneda:                             ‚îÇ
‚îÇ [USD ‚ñº]                             ‚îÇ
‚îÇ                                     ‚îÇ
‚îÇ Monto:                              ‚îÇ
‚îÇ [100.00]                            ‚îÇ
‚îÇ                                     ‚îÇ
‚îÇ Descripci√≥n:                        ‚îÇ
‚îÇ [Retiro para gastos operativos]    ‚îÇ
‚îÇ                                     ‚îÇ
‚îÇ Saldo actual: $1,100.00             ‚îÇ
‚îÇ Saldo despu√©s: $1,000.00            ‚îÇ
‚îÇ                                     ‚îÇ
‚îÇ [Cancelar] [Registrar Movimiento]  ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

---

## üöÄ Pr√≥ximos Pasos

### 1. Crear Interfaz Frontend
- [ ] P√°gina principal de fondo de caja
- [ ] Modal para registrar movimientos
- [ ] P√°gina de historial con filtros
- [ ] Estad√≠sticas y gr√°ficas

### 2. Integrar con √ìrdenes
- [ ] Observer para actualizar saldos autom√°ticamente
- [ ] Validar saldo suficiente antes de completar orden
- [ ] Mostrar saldo disponible al crear orden

### 3. Reportes y Alertas
- [ ] Reporte de cierre de caja diario
- [ ] Alertas de saldo bajo
- [ ] Conciliaci√≥n de saldos

### 4. Permisos y Seguridad
- [ ] Solo operadores pueden ver su propia caja
- [ ] Casas de cambio pueden ver todas las cajas
- [ ] Auditor√≠a de movimientos manuales

---

## üí° Beneficios

### Para Operadores
- ‚úÖ Control total de sus fondos
- ‚úÖ Transparencia en movimientos
- ‚úÖ Facilita cierre de caja
- ‚úÖ Reduce errores de conteo

### Para Casas de Cambio
- ‚úÖ Visibilidad de fondos de todos los operadores
- ‚úÖ Mejor control financiero
- ‚úÖ Auditor√≠a completa
- ‚úÖ Reportes consolidados

### Para el Sistema
- ‚úÖ Trazabilidad completa
- ‚úÖ Conciliaci√≥n autom√°tica
- ‚úÖ Prevenci√≥n de fraudes
- ‚úÖ Datos para an√°lisis

---

## üîê Seguridad

### Validaciones
- ‚úÖ No permitir retiros mayores al saldo
- ‚úÖ Validar permisos de usuario
- ‚úÖ Registrar IP y timestamp
- ‚úÖ Transacciones at√≥micas (DB)

### Auditor√≠a
- ‚úÖ Cada movimiento queda registrado
- ‚úÖ Balance antes y despu√©s
- ‚úÖ Usuario responsable
- ‚úÖ Descripci√≥n obligatoria

---

## üìù Notas T√©cnicas

### M√©todos del Modelo `OperatorCashBalance`

```php
// Incrementar saldo
$balance->increment($amount, $description, $orderId, $type);

// Decrementar saldo
$balance->decrement($amount, $description, $orderId, $type);
```

### Tipos de Movimientos

- `deposit`: Dep√≥sito manual
- `withdrawal`: Retiro manual
- `order_in`: Entrada por orden (cliente paga)
- `order_out`: Salida por orden (operador entrega)
- `adjustment`: Ajuste/correcci√≥n

### Scopes del Modelo `CashMovement`

```php
// Filtrar por operador
CashMovement::forOperator($operatorId)->get();

// Filtrar por m√©todo de pago
CashMovement::forPaymentMethod($paymentMethodId)->get();

// Filtrar por tipo
CashMovement::ofType('deposit')->get();
```

---

## üéâ Conclusi√≥n

El sistema de control de caja proporciona:

1. ‚úÖ **Control total** de fondos por operador
2. ‚úÖ **Actualizaci√≥n autom√°tica** con √≥rdenes
3. ‚úÖ **Historial completo** de movimientos
4. ‚úÖ **Transparencia** y auditor√≠a
5. ‚úÖ **Facilita** cierre de caja diario

**Estado Actual:** ‚úÖ Backend Completado (80%)  
**Pendiente:** Frontend y integraci√≥n con √≥rdenes (20%)

**Fecha de implementaci√≥n:** Octubre 2025  
**Versi√≥n:** 1.0 - Control de Caja
